services:
  webserver:
    build:
      context: ./services/nginx
      dockerfile: Dockerfile
    container_name: webserver
    ports:
      - "80:80"
    restart: unless-stopped
    depends_on:
      php81:
        condition: service_healthy
      php82:
        condition: service_healthy
      php83:
        condition: service_healthy
      php84:
        condition: service_healthy
    volumes:
      - ./config/vhosts:/etc/nginx/conf.d:ro
      - ./sites:/var/www/sites:rw
      - ./templates:/var/www/templates:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
       - "3306:3306"
    restart: unless-stopped
    command: >
      --innodb-buffer-pool-size=${MYSQL_INNODB_BUFFER_POOL_SIZE:-2G}
      --innodb-log-file-size=${MYSQL_INNODB_LOG_FILE_SIZE:-512M}
      --innodb-flush-log-at-trx-commit=${MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT:-2}
      --innodb-flush-method=O_DIRECT
      --innodb-buffer-pool-instances=2
      --innodb-io-capacity=2000
      --innodb-io-capacity-max=4000
      --max-connections=${MYSQL_MAX_CONNECTIONS:-200}
      --table-open-cache=${MYSQL_TABLE_OPEN_CACHE:-4000}
      --sort-buffer-size=${MYSQL_SORT_BUFFER_SIZE:-4M}
      --read-buffer-size=${MYSQL_READ_BUFFER_SIZE:-2M}
      --join-buffer-size=${MYSQL_JOIN_BUFFER_SIZE:-2M}
      --tmp-table-size=${MYSQL_TMP_TABLE_SIZE:-128M}
      --max-heap-table-size=${MYSQL_MAX_HEAP_TABLE_SIZE:-128M}
      --skip-name-resolve
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  php81:
    build:
      context: ./services/php-fpm/php8.1
      dockerfile: Dockerfile
      args:
        UID: "${UID:-1000}"
    container_name: php81
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./sites:/var/www/sites:rw
      - ./credentials:/var/www/credentials:ro
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  php82:
    build:
      context: ./services/php-fpm/php8.2
      dockerfile: Dockerfile
      args:
        UID: "${UID:-1000}"
    container_name: php82
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./sites:/var/www/sites:rw
      - ./credentials:/var/www/credentials:ro
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  php83:
    build:
      context: ./services/php-fpm/php8.3
      dockerfile: Dockerfile
      args:
        UID: "${UID:-1000}"
    container_name: php83
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./sites:/var/www/sites:rw
      - ./credentials:/var/www/credentials:ro
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  php84:
    build:
      context: ./services/php-fpm/php8.4
      dockerfile: Dockerfile
      args:
        UID: "${UID:-1000}"
    container_name: php84
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./sites:/var/www/sites:rw
      - ./credentials:/var/www/credentials:ro
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --appendonly yes --appendfsync everysec
    volumes:
      - redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

volumes:
  redis:
  mysql_data: